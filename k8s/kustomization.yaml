apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: scheduled-db
  annotations:
    config.kubernetes.io/local-config: "true"

namespace: default

namePrefix: ""
nameSuffix: ""

commonLabels:
  app: scheduled-db
  version: v1.0.0
  component: database

commonAnnotations:
  app.kubernetes.io/name: scheduled-db
  app.kubernetes.io/version: v1.0.0
  app.kubernetes.io/component: database
  app.kubernetes.io/part-of: scheduled-db-cluster
  app.kubernetes.io/managed-by: kustomize

resources:
- configmap.yaml
- rbac.yaml
- service.yaml
- statefulset.yaml
- pdb.yaml
- hpa.yaml

images:
- name: scheduled-db
  newName: scheduled-db
  newTag: latest

replicas:
- name: scheduled-db
  count: 3

configMapGenerator:
- name: scheduled-db-env-config
  literals:
  - ENVIRONMENT=production
  - CLUSTER_NAME=scheduled-db-cluster
  - ENABLE_METRICS=true
  - LOG_FORMAT=json

patches:
- target:
    kind: StatefulSet
    name: scheduled-db
  patch: |-
    - op: add
      path: /spec/template/metadata/annotations/config.k8s.io~1last-applied-configuration
      value: "managed-by-kustomize"

- target:
    kind: Service
    name: scheduled-db-api
  patch: |-
    - op: add
      path: /metadata/annotations/service.beta.kubernetes.io~1aws-load-balancer-type
      value: "nlb"

patchesStrategicMerge:
- |-
  apiVersion: apps/v1
  kind: StatefulSet
  metadata:
    name: scheduled-db
  spec:
    template:
      spec:
        containers:
        - name: scheduled-db
          env:
          - name: KUSTOMIZE_MANAGED
            value: "true"
