apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: scheduled-db-monitoring
  namespace: default

resources:
  # Prometheus
  - prometheus-config.yaml
  - prometheus-deployment.yaml

  # Grafana Operator
  - grafana-resources.yaml


  # ServiceMonitors (optional - for Prometheus Operator)
  - servicemonitor.yaml

commonLabels:
  monitoring-stack: scheduled-db
  environment: production

namePrefix: monitoring-

namespace: default

images:
  - name: prom/prometheus
    newTag: v2.47.0
  - name: otel/opentelemetry-collector-contrib
    newTag: 0.89.0

configMapGenerator:
  - name: monitoring-info
    literals:
      - version=1.0.0
      - cluster=scheduled-db-cluster
      - environment=production
      - prometheus.url=http://prometheus:9090
      - grafana.url=http://grafana:3000
      - otel-collector.url=http://otel-collector:4318

patches:
  # Add common labels to all resources
  - target:
      group: apps
      version: v1
      kind: Deployment
    patch: |-
      - op: add
        path: /metadata/labels/component
        value: monitoring
      - op: add
        path: /spec/template/metadata/labels/component
        value: monitoring

  # Add resource limits based on environment
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: prometheus
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 2Gi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 1000m

  # Configure Grafana with additional environment variables
  - target:
      group: integreatly.org
      version: v1beta1
      kind: Grafana
      name: grafana
    patch: |-
      - op: add
        path: /spec/config/feature_toggles
        value:
          enable: "alertingBigTransactions"

replicas:
  - name: prometheus
    count: 1
  - name: otel-collector
    count: 1
