apiVersion: grafana.integreatly.org/v1beta1
kind: Grafana
metadata:
  name: grafana
  namespace: default
  labels:
    app: grafana
spec:
  config:
    log:
      mode: "console"
      level: "info"
    security:
      admin_user: "admin"
      admin_password: "admin123"
    server:
      http_port: "3000"
      root_url: "http://localhost:3000/"
  deployment:
    spec:
      replicas: 1
  service:
    spec:
      type: ClusterIP
      ports:
      - name: http
        port: 3000
        targetPort: 3000
  persistentVolumeClaim:
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 5Gi
---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDatasource
metadata:
  name: prometheus-datasource
  namespace: default
  labels:
    app: grafana
spec:
  instanceSelector:
    matchLabels:
      app: grafana
  datasource:
    name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    editable: true
    uid: prometheus-uid
    jsonData:
      timeInterval: 15s
      httpMethod: POST
---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDashboard
metadata:
  name: scheduled-db-dashboard
  namespace: default
  labels:
    app: grafana
spec:
  instanceSelector:
    matchLabels:
      app: grafana
  json: |
    {
      "id": null,
      "uid": "scheduled-db-uid",
      "title": "Scheduled-DB Monitoring",
      "tags": ["scheduled-db", "jobs", "cluster"],
      "style": "dark",
      "timezone": "browser",
      "refresh": "30s",
      "schemaVersion": 27,
      "version": 1,
      "time": {
        "from": "now-1h",
        "to": "now"
      },
      "panels": [
        {
          "id": 1,
          "title": "Cluster Status",
          "type": "stat",
          "targets": [
            {
              "expr": "cluster_nodes",
              "legendFormat": "Nodes",
              "refId": "A"
            }
          ],
          "gridPos": {"h": 6, "w": 4, "x": 0, "y": 0}
        },
        {
          "id": 2,
          "title": "Active Jobs",
          "type": "stat",
          "targets": [
            {
              "expr": "jobs_active",
              "legendFormat": "Active",
              "refId": "A"
            }
          ],
          "gridPos": {"h": 6, "w": 4, "x": 4, "y": 0}
        },
        {
          "id": 3,
          "title": "Worker Status",
          "type": "stat",
          "targets": [
            {
              "expr": "worker_active",
              "legendFormat": "Workers",
              "refId": "A"
            }
          ],
          "gridPos": {"h": 6, "w": 4, "x": 8, "y": 0}
        },
        {
          "id": 4,
          "title": "Active Slots",
          "type": "stat",
          "targets": [
            {
              "expr": "slots_active",
              "legendFormat": "Slots",
              "refId": "A"
            }
          ],
          "gridPos": {"h": 6, "w": 4, "x": 12, "y": 0}
        },
        {
          "id": 5,
          "title": "System Uptime",
          "type": "stat",
          "targets": [
            {
              "expr": "system_uptime_seconds / 3600",
              "legendFormat": "Hours",
              "refId": "A"
            }
          ],
          "gridPos": {"h": 6, "w": 4, "x": 16, "y": 0}
        },
        {
          "id": 6,
          "title": "Job Execution Rate",
          "type": "timeseries",
          "targets": [
            {
              "expr": "rate(jobs_executed_total[5m])",
              "legendFormat": "Success - {{job_type}}",
              "refId": "A"
            },
            {
              "expr": "rate(jobs_failed_total[5m])",
              "legendFormat": "Failed - {{job_type}}",
              "refId": "B"
            }
          ],
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 6}
        },
        {
          "id": 7,
          "title": "Jobs by Type",
          "type": "timeseries",
          "targets": [
            {
              "expr": "jobs_by_type",
              "legendFormat": "{{job_type}}",
              "refId": "A"
            }
          ],
          "gridPos": {"h": 8, "w": 8, "x": 12, "y": 6}
        },
        {
          "id": 8,
          "title": "Job Execution Duration",
          "type": "timeseries",
          "targets": [
            {
              "expr": "histogram_quantile(0.50, rate(job_execution_duration_seconds_bucket[5m]))",
              "legendFormat": "p50",
              "refId": "A"
            },
            {
              "expr": "histogram_quantile(0.95, rate(job_execution_duration_seconds_bucket[5m]))",
              "legendFormat": "p95",
              "refId": "B"
            },
            {
              "expr": "histogram_quantile(0.99, rate(job_execution_duration_seconds_bucket[5m]))",
              "legendFormat": "p99",
              "refId": "C"
            }
          ],
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 14}
        },
        {
          "id": 9,
          "title": "Slot Processing",
          "type": "timeseries",
          "targets": [
            {
              "expr": "rate(slots_processed_total[5m])",
              "legendFormat": "Slots/sec",
              "refId": "A"
            },
            {
              "expr": "histogram_quantile(0.95, rate(jobs_per_slot_bucket[5m]))",
              "legendFormat": "Jobs per slot (p95)",
              "refId": "B"
            }
          ],
          "gridPos": {"h": 8, "w": 8, "x": 12, "y": 14}
        },
        {
          "id": 10,
          "title": "Cluster Events",
          "type": "timeseries",
          "targets": [
            {
              "expr": "rate(cluster_leader_changes_total[1h])",
              "legendFormat": "Leader Changes/hour",
              "refId": "A"
            },
            {
              "expr": "rate(cluster_join_events_total[5m])",
              "legendFormat": "Join Events/sec",
              "refId": "B"
            },
            {
              "expr": "rate(cluster_leave_events_total[5m])",
              "legendFormat": "Leave Events/sec",
              "refId": "C"
            }
          ],
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 22}
        },
        {
          "id": 11,
          "title": "Raft Operations",
          "type": "timeseries",
          "targets": [
            {
              "expr": "rate(raft_operations_total[5m])",
              "legendFormat": "{{operation}} - {{status}}",
              "refId": "A"
            },
            {
              "expr": "rate(raft_leader_elections_total[5m])",
              "legendFormat": "Elections/sec",
              "refId": "B"
            }
          ],
          "gridPos": {"h": 8, "w": 8, "x": 12, "y": 22}
        },
        {
          "id": 12,
          "title": "HTTP API Performance",
          "type": "timeseries",
          "targets": [
            {
              "expr": "rate(http_requests_total[5m])",
              "legendFormat": "{{method}} {{endpoint}} - {{status_code}}",
              "refId": "A"
            },
            {
              "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
              "legendFormat": "Response time p95",
              "refId": "B"
            }
          ],
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 30}
        },
        {
          "id": 13,
          "title": "Worker Performance",
          "type": "timeseries",
          "targets": [
            {
              "expr": "histogram_quantile(0.95, rate(worker_processing_time_seconds_bucket[5m]))",
              "legendFormat": "Processing time p95",
              "refId": "A"
            },
            {
              "expr": "histogram_quantile(0.95, rate(worker_idle_time_seconds_bucket[5m]))",
              "legendFormat": "Idle time p95",
              "refId": "B"
            },
            {
              "expr": "rate(worker_errors_total[5m])",
              "legendFormat": "Errors/sec - {{error_type}}",
              "refId": "C"
            }
          ],
          "gridPos": {"h": 8, "w": 8, "x": 12, "y": 30}
        },
        {
          "id": 14,
          "title": "Discovery & Webhooks",
          "type": "timeseries",
          "targets": [
            {
              "expr": "rate(discovery_events_total[5m])",
              "legendFormat": "Discovery {{strategy}} - {{event_type}}",
              "refId": "A"
            },
            {
              "expr": "nodes_discovered",
              "legendFormat": "Nodes discovered - {{strategy}}",
              "refId": "B"
            },
            {
              "expr": "rate(webhook_requests_total[5m])",
              "legendFormat": "Webhooks - {{status}}",
              "refId": "C"
            }
          ],
          "gridPos": {"h": 8, "w": 20, "x": 0, "y": 38}
        }
      ]
    }
